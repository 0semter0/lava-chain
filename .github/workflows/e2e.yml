name: Lava E2E Tests

on: 
  pull_request

jobs:
  test-protocol-e2e:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version: 1.20.5

      ######################################################
      ### Run Lava Protocol E2E Tests
      ######################################################
      - name: Run Lava E2E Tests -timeout 1200s
        run: |
          go install github.com/jstemmer/go-junit-report/v2@latest
          go test ./testutil/e2e/ -run ^TestLavaProtocol$ -v -timeout 1200s | go-junit-report -iocopy -set-exit-code -out protocol-e2e-report.xml  # 20mins
      
      - name: Test Summary
        uses: test-summary/action@v2
        if: always()
        with:
          paths: |
            *-report.xml

      - name: tail -n 1000 Lavad Logs
        if: always()
        run: tail -n 1000 testutil/e2e/protocolLogs/00_StartLava.log
      
      - name: Print all warnings and errors from lavad
        continue-on-error: true
        if: always()
        run: cat testutil/e2e/protocolLogs/00_StartLava.log | grep 'WRN |ERR '

      - name: Stake Lava All Logs
        if: always()
        run: cat testutil/e2e/protocolLogs/01_stakeLava.log

      - name: Stake Lava Error Only Logs
        if: always()
        continue-on-error: true
        run: cat testutil/e2e/protocolLogs/01_stakeLava_errors.log

      - name: head -n 300 JSON Proxy Logs
        if: always()
        run: head -n 300 testutil/e2e/protocolLogs/02_jsonProxy.log

      - name: tail -n 300 JSON Proxy Logs
        if: always()
        run: tail -n 300 testutil/e2e/protocolLogs/02_jsonProxy.log

      - name: JSON Proxy Error Only Logs
        if: always()
        continue-on-error: true
        run: cat testutil/e2e/protocolLogs/02_jsonProxy_errors.log

      - name: JSON Provider All Logs
        if: always()
        run: grep "" testutil/e2e/protocolLogs/03_EthProvider* --exclude="*errors*"

      - name: JSON Provider Error Only Logs
        if: always()
        continue-on-error: true
        run: grep "" testutil/e2e/protocolLogs/03_EthProvider* --include="*errors*"

      - name: JSON Consumer All Logs
        if: always()
        run: grep "" testutil/e2e/protocolLogs/04_jsonConsumer* --exclude="*errors*"

      - name: JSON Consumer Error Only Logs
        if: always()
        continue-on-error: true
        run: grep "" testutil/e2e/protocolLogs/04_jsonConsumer* --include="*errors*"

      - name: Lava Provider All Logs
        if: always()
        run: grep "" testutil/e2e/protocolLogs/05_LavaProvider* --exclude="*errors*"

      - name: Lava Provider Error Only Logs
        if: always()
        continue-on-error: true
        run: grep "" testutil/e2e/protocolLogs/05_LavaProvider* --include="*errors*"

      - name: Lava over Lava All Logs
        if: always()
        run: cat testutil/e2e/protocolLogs/07_lavaOverLava.log

      - name: Lava over Lava Error Only Logs
        if: always()
        continue-on-error: true
        run: cat testutil/e2e/protocolLogs/07_lavaOverLava_errors.log

      - name: RPCConsumer Consumer All Logs
        if: always()
        run: grep "" testutil/e2e/protocolLogs/06_RPCConsumer* --exclude="*errors*"

      - name: RPCConsumer Consumer Error Only Logs
        if: always()
        continue-on-error: true
        run: grep "" testutil/e2e/protocolLogs/06_RPCConsumer* --include="*errors*"

  test-sdk-e2e:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version: "1.20.5"

      # Install Node.js
      - name: Setup Node.js environment
        uses: actions/setup-node@v4
        with:
          node-version: "21.2.0"

      - name: Init the SDK
        run: GOPATH=~/go ./scripts/init_sdk.sh -s
        working-directory: ./ecosystem/lava-sdk

      - name: Build
        run: yarn build
        working-directory: ./ecosystem/lava-sdk

      - name: Install ts-node
        run: npm install -g ts-node

      - name: Install telescope dependencies
        run: yarn; yarn e2e-setup
        working-directory: ./ecosystem/lavajs

      - name: Setup test environment
        run: npm init --yes; npm install --save-dev @types/node

      ######################################################
      ### Run Lava SDK E2E Tests
      ######################################################
      - name: Run Lava E2E Tests  -timeout 1200s
        run: |
          go install github.com/jstemmer/go-junit-report/v2@latest
          go test ./testutil/e2e/ -run ^TestLavaSDK -v -timeout 1200s | go-junit-report -iocopy -set-exit-code -out sdk-e2e-report.xml # 20mins

      - name: Test Summary
        uses: test-summary/action@v2
        if: always()
        with:
          paths: |

      - name: tail -n 300 Lavad Logs
        if: always()
        run: tail -n 300 testutil/e2e/sdkLogs/00_StartLava.log

      - name: Stake Lava All Logs
        if: always()
        run: cat testutil/e2e/sdkLogs/01_stakeLava.log

      - name: Stake Lava Error Only Logs
        if: always()
        continue-on-error: true
        run: cat testutil/e2e/sdkLogs/01_stakeLava_errors.log

      - name: head -n 300 JSON Proxy Logs
        if: always()
        run: head -n 300 testutil/e2e/sdkLogs/02_jsonProxy.log

      - name: tail -n 300 JSON Proxy Logs
        if: always()
        run: tail -n 300 testutil/e2e/sdkLogs/02_jsonProxy.log

      - name: JSON Proxy Error Only Logs
        if: always()
        continue-on-error: true
        run: cat testutil/e2e/sdkLogs/02_jsonProxy_errors.log

      - name: JSON Provider All Logs
        if: always()
        run: grep "" testutil/e2e/sdkLogs/03_EthProvider* --exclude="*errors*"

      - name: JSON Provider Error Only Logs
        if: always()
        continue-on-error: true
        run: grep "" testutil/e2e/sdkLogs/03_EthProvider* --include="*errors*"

      - name: Lava Provider All Logs
        if: always()
        run: grep "" testutil/e2e/sdkLogs/05_LavaProvider* --exclude="*errors*"

      - name: Lava Provider Error Only Logs
        if: always()
        continue-on-error: true
        run: grep "" testutil/e2e/sdkLogs/05_LavaProvider* --include="*errors*"

      - name: Badge Server All Logs
        if: always()
        run: grep "" testutil/e2e/sdkLogs/01_BadgeServer* --exclude="*errors*"

      - name: Badge Server Error Only Logs
        if: always()
        continue-on-error: true
        run: grep "" testutil/e2e/sdkLogs/01_BadgeServer* --include="*errors*"

      - name: Lava SDK All Logs
        if: always()
        run: grep "" testutil/e2e/sdkLogs/01_sdkTest* --exclude="*errors*"

      - name: Lava SDK Error Only Logs
        if: always()
        continue-on-error: true
        run: grep "" testutil/e2e/sdkLogs/01_sdkTest* --include="*errors*"

  test-payment-e2e:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: 1.20.5

      ######################################################
      ### Run Lava Protocol Payment E2E Tests
      ######################################################
      - name: Run Lava Payment E2E Tests -timeout 1200s
        run: |
          go install github.com/jstemmer/go-junit-report/v2@latest
          go test ./testutil/e2e/ -run ^TestLavaProtocolPayment$ -v -timeout 1200s | go-junit-report -iocopy -set-exit-code -out payment-e2e-report.xml # 20mins
      
      - name: Test Summary
        uses: test-summary/action@v2
        if: always()
        with:
          paths: |
            *-report.xml

      - name: tail -n 300 Lavad Logs
        if: always()
        run: tail -n 300 testutil/e2e/protocolLogs/00_StartLava.log

      - name: Stake Lava All Logs
        if: always()
        run: cat testutil/e2e/protocolLogs/01_stakeLavaForPayment.log

      - name: Stake Lava Error Only Logs
        if: always()
        continue-on-error: true
        run: cat testutil/e2e/protocolLogs/01_stakeLava_errors.log

      - name: Lava Provider All Logs
        if: always()
        run: grep "" testutil/e2e/protocolLogs/05_LavaProvider* --exclude="*errors*"

      - name: Lava Provider Error Only Logs
        if: always()
        continue-on-error: true
        run: grep "" testutil/e2e/protocolLogs/05_LavaProvider* --include="*errors*"

      - name: RPCConsumer Consumer All Logs
        if: always()
        run: grep "" testutil/e2e/protocolLogs/06_RPCConsumer* --exclude="*errors*"

      - name: RPCConsumer Consumer Error Only Logs
        if: always()
        continue-on-error: true
        run: grep "" testutil/e2e/protocolLogs/06_RPCConsumer* --include="*errors*"
